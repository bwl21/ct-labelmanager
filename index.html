<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChurchTools Tag Manager - Real API</title>
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <div id="app" class="ct-app min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-semibold ct-text-primary">ChurchTools Tag Manager</h1>
                    <div v-if="isAuthenticated" class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">{{ currentUser }}</span>
                        <button @click="logout" class="ct-btn ct-btn-outline-primary ct-btn-sm">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4">
            <!-- Login Form -->
            <div v-if="!isAuthenticated" class="max-w-md mx-auto">
                <div class="ct-card">
                    <div class="ct-card-header">
                        <h2 class="text-lg font-semibold">Login to ChurchTools</h2>
                        <p class="text-sm text-gray-600 mt-1">Enter your credentials to manage tags</p>
                    </div>
                    <div class="ct-card-body space-y-4">
                        <div>
                            <label class="ct-form-label">ChurchTools URL</label>
                            <input v-model="loginForm.baseUrl" type="url" class="ct-form-control" placeholder="https://your-church.church.tools">
                        </div>
                        <div>
                            <label class="ct-form-label">Username</label>
                            <input v-model="loginForm.username" type="text" class="ct-form-control" placeholder="Your username" @keyup.enter="login">
                        </div>
                        <div>
                            <label class="ct-form-label">Password</label>
                            <input v-model="loginForm.password" type="password" class="ct-form-control" placeholder="Your password" @keyup.enter="login">
                        </div>
                        <div v-if="loginError" class="ct-alert ct-alert-danger">
                            <strong>Error:</strong> {{ loginError }}
                        </div>
                        <div v-if="loginStatus" class="ct-alert ct-alert-info">
                            {{ loginStatus }}
                        </div>
                        <button @click="login" :disabled="isLoading" class="ct-btn ct-btn-primary w-full ct-btn-lg">
                            <span v-if="isLoading" class="spinner"></span>
                            {{ isLoading ? 'Logging in...' : 'Login to ChurchTools' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tag Manager -->
            <div v-else>
                <!-- Controls -->
                <div class="flex justify-between items-center mb-4">
                    <div class="flex items-center space-x-4">
                        <h2 class="text-xl font-semibold">Tag Manager</h2>
                        <select v-model="selectedType" @change="loadTags" class="ct-form-select" style="width: auto;">
                            <option value="person">Person Tags</option>
                            <option value="group">Group Tags</option>
                            <option value="song">Song Tags</option>
                            <option value="appointment">Appointment Tags</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="loadTags" class="ct-btn ct-btn-outline-primary ct-btn-sm">
                            <span v-if="isLoadingTags" class="spinner"></span>
                            Refresh
                        </button>
                        <button @click="showCreateForm = true" class="ct-btn ct-btn-primary ct-btn-sm">Create Tag</button>
                    </div>
                </div>

                <!-- Bulk Operations -->
                <div class="ct-card mb-4">
                    <div class="ct-card-header">
                        <div class="flex items-center justify-between">
                            <h3 class="font-semibold text-gray-800">ðŸ”§ Bulk Operations</h3>
                            <span class="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">{{ selectedTags.length }} selected</span>
                        </div>
                    </div>
                    <div class="ct-card-body">
                        <div class="flex flex-wrap items-center" style="gap: 2rem;">
                            <!-- Selection Group -->
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <button @click="selectAll" class="ct-btn ct-btn-outline-primary ct-btn-sm" style="height: 36px;">Select All</button>
                                    <button @click="clearSelection" class="ct-btn ct-btn-outline-primary ct-btn-sm" style="height: 36px;">Clear Selection</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <input 
                                        v-model="prefixFilter" 
                                        type="text" 
                                        placeholder="e.g., L:*" 
                                        class="ct-form-control" 
                                        style="width: 120px; height: 36px;"
                                    >
                                    <button @click="selectByPrefix" class="ct-btn ct-btn-outline-primary ct-btn-sm" style="height: 36px;">Select by Prefix</button>
                                </div>
                            </div>
                            
                            <!-- Color Group -->
                            <div class="flex items-center gap-2">
                                <button 
                                    @click="openColorPicker('bulk')" 
                                    class="color-dropdown-button"
                                    type="button"
                                    style="min-width: 200px; height: 36px; font-size: 14px;"
                                >
                                    <div class="color-dropdown-content">
                                        <span 
                                            v-if="bulkColor"
                                            class="color-dropdown-circle" 
                                            :class="{ white: bulkColor === 'white' }"
                                            :style="{ backgroundColor: getColorInfo(bulkColor).hex, width: '18px', height: '18px' }"
                                        ></span>
                                        <span v-else class="color-dropdown-circle empty" style="width: 18px; height: 18px;"></span>
                                        <div class="color-dropdown-info">
                                            <span class="color-dropdown-name">{{ bulkColor ? getColorInfo(bulkColor).name : 'Select Color' }}</span>
                                            <span v-if="bulkColor" class="color-dropdown-hex">{{ getColorInfo(bulkColor).hex }}</span>
                                        </div>
                                    </div>
                                    <span class="color-dropdown-arrow">â–¼</span>
                                </button>
                                <button @click="applyBulkColor" :disabled="!bulkColor || isBulkOperating" class="ct-btn ct-btn-success ct-btn-sm" style="height: 36px; min-width: 100px;">
                                    <span v-if="isBulkOperating" class="spinner"></span>
                                    Apply Color
                                </button>
                            </div>
                            
                            <!-- Delete Group -->
                            <div>
                                <button @click="bulkDelete" :disabled="isBulkOperating" class="ct-btn ct-btn-danger ct-btn-sm" style="height: 36px; min-width: 120px;">
                                <span v-if="isBulkOperating" class="spinner"></span>
                                Delete Selected
                            </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Create/Edit Modal -->
                <div v-if="showCreateForm || editingTag" class="modal-overlay" @click.self="cancelEdit">
                    <div class="modal-content">
                        <div class="ct-card-header">
                            <h3 class="font-semibold">{{ editingTag ? 'Edit Tag' : 'Create New Tag' }}</h3>
                        </div>
                        <div class="ct-card-body space-y-4">
                            <div>
                                <label class="ct-form-label">Tag Name</label>
                                <input 
                                    v-model="tagForm.name" 
                                    type="text" 
                                    class="ct-form-control" 
                                    placeholder="Enter tag name (1-100 characters)"
                                    maxlength="100"
                                >
                                <p class="text-xs text-gray-500 mt-1">{{ tagForm.name.length }}/100 characters</p>
                            </div>
                            <div>
                                <label class="ct-form-label">Description</label>
                                <input 
                                    v-model="tagForm.description" 
                                    type="text" 
                                    class="ct-form-control" 
                                    placeholder="Enter tag description (optional)"
                                    maxlength="255"
                                >
                                <p class="text-xs text-gray-500 mt-1">{{ (tagForm.description || '').length }}/255 characters</p>
                            </div>
                            <div>
                                <label class="ct-form-label">Color</label>
                                <button 
                                    @click="openColorPicker('tag')" 
                                    class="color-dropdown-button"
                                    type="button"
                                >
                                    <div class="color-dropdown-content">
                                        <span 
                                            v-if="tagForm.color"
                                            class="color-dropdown-circle" 
                                            :class="{ white: tagForm.color === 'white' }"
                                            :style="{ backgroundColor: getColorInfo(tagForm.color).hex }"
                                        ></span>
                                        <span v-else class="color-dropdown-circle empty"></span>
                                        <div class="color-dropdown-info">
                                            <span class="color-dropdown-name">{{ tagForm.color ? getColorInfo(tagForm.color).name : 'Select a color' }}</span>
                                            <span v-if="tagForm.color" class="color-dropdown-hex">{{ getColorInfo(tagForm.color).hex }}</span>
                                        </div>
                                    </div>
                                    <span class="color-dropdown-arrow">â–¼</span>
                                </button>
                            </div>
                            <div v-if="tagError" class="ct-alert ct-alert-danger">{{ tagError }}</div>
                            <div class="flex space-x-2">
                                <button @click="saveTag" :disabled="isSaving" class="ct-btn ct-btn-primary">
                                    <span v-if="isSaving" class="spinner"></span>
                                    {{ editingTag ? 'Update' : 'Create' }}
                                </button>
                                <button @click="cancelEdit" class="ct-btn ct-btn-secondary">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tags Table -->
                <div class="ct-card">
                    <div class="ct-card-header">
                        <h3 class="font-semibold">{{ getDisplayName(selectedType) }} ({{ tags.length }})</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="ct-table">
                            <thead>
                                <tr>
                                    <th class="w-12">
                                        <input
                                            type="checkbox"
                                            :checked="allSelected"
                                            @change="toggleSelectAll"
                                            class="rounded"
                                        />
                                    </th>
                                    <th @click="sortBy('id')" style="cursor: pointer;">
                                        ID 
                                        <span v-if="sortField === 'id'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                    </th>
                                    <th @click="sortBy('name')" style="cursor: pointer;">
                                        Name 
                                        <span v-if="sortField === 'name'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                    </th>
                                    <th @click="sortBy('description')" style="cursor: pointer;">
                                        Description 
                                        <span v-if="sortField === 'description'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                    </th>
                                    <th @click="sortBy('color')" style="cursor: pointer;">
                                        Color 
                                        <span v-if="sortField === 'color'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
                                    </th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="tag in sortedTags" :key="tag.id" :class="{ 'bg-blue-50': selectedTags.includes(tag.id) }">
                                    <td>
                                        <input
                                            type="checkbox"
                                            :checked="selectedTags.includes(tag.id)"
                                            @change="toggleTagSelection(tag.id)"
                                            class="rounded"
                                        />
                                    </td>
                                    <td class="text-gray-500">{{ tag.id }}</td>
                                    <td class="font-semibold">{{ tag.name }}</td>
                                    <td class="text-sm text-gray-600">{{ tag.description || '-' }}</td>
                                    <td>
                                        <div v-if="tag.color" class="flex items-center gap-4">
                                            <span :class="`color-dot ct-color-${tag.color}`" :title="`${getColorInfo(tag.color).name} (${getColorInfo(tag.color).hex})`"></span>
                                            <div>
                                                <div class="font-medium text-sm">{{ getColorInfo(tag.color).name }}</div>
                                                <div class="text-xs text-gray-500">{{ getColorInfo(tag.color).hex }}</div>
                                            </div>
                                        </div>
                                        <div v-else class="flex items-center gap-4">
                                            <span class="color-dot" style="background-color: #f3f4f6; border-color: #d1d5db;"></span>
                                            <div>
                                                <div class="font-medium text-sm text-gray-400">No color</div>
                                                <div class="text-xs text-gray-400">-</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <button @click="editTag(tag)" class="ct-btn ct-btn-outline-primary ct-btn-sm mr-2">Edit</button>
                                        <button @click="deleteTag(tag)" class="ct-btn ct-btn-danger ct-btn-sm">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div v-if="isLoadingTags" class="ct-card-body text-center">
                            <span class="spinner"></span> Loading tags...
                        </div>
                        <div v-else-if="tags.length === 0" class="ct-card-body text-center text-gray-500">
                            No tags found. Create your first tag to get started.
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Toast Container -->
        <div id="toast-container">
            <div v-for="toast in toasts" :key="toast.id" :class="['ct-toast', `ct-toast-${toast.type}`, { 'slide-out': toast.removing }]">
                <button @click="removeToast(toast.id)" class="ct-toast-close">&times;</button>
                <div class="ct-toast-title">{{ toast.title }}</div>
                <div class="ct-toast-message">{{ toast.message }}</div>
            </div>
        </div>
        
        <!-- Color Picker Modal -->
        <div v-if="showColorPicker" class="color-picker-modal" @click.self="closeColorPicker">
            <div class="color-picker-content">
                <div class="color-picker-header">
                    <div>
                        <h3 class="color-picker-title">Choose a Color</h3>
                        <p style="font-size: 0.875rem; color: #6b7280; margin: 0.25rem 0 0 0;">Click a color to select it, or press Escape to cancel</p>
                    </div>
                    <button @click="closeColorPicker" class="color-picker-close">&times;</button>
                </div>
                
                <div class="color-picker-body">
                    <!-- No Color Option at top -->
                    <div style="margin-bottom: 1rem;">
                        <div 
                            @click="selectColorInPicker('')"
                            class="color-option"
                            style="max-width: 280px;"
                        >
                            <span class="color-option-circle empty"></span>
                            <div class="color-option-info">
                                <div class="color-option-name">No Color</div>
                                <div class="color-option-hex">Remove color</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="color-grid">
                        <div 
                            v-for="color in sortedColorOptions" 
                            :key="color.value"
                            @click="selectColorInPicker(color.value)"
                            class="color-option"
                        >
                            <span 
                                class="color-option-circle" 
                                :class="{ white: color.value === 'white' }"
                                :style="{ backgroundColor: color.hex }"
                            ></span>
                            <div class="color-option-info">
                                <div class="color-option-name">{{ color.label }}</div>
                                <div class="color-option-hex">{{ color.hex }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="app.js"></script>

</body>
</html>